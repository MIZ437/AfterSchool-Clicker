# Changelog - 放課後クリッカー


## 2025-10-30

### Added
- ✨ **シーン別ズーム制御機能実装**
  - タイトル、シナリオ、説明、エンディング画面: **100%ズーム** (画面いっぱいに大きく表示)
  - ゲーム、アルバム、設定画面: **動的ズーム** (UI要素が見切れないように自動縮小)
  - シーン切り替え時に自動的に最適なズーム率を適用
  - 別PCでのテスト結果を受けて、ストーリー画面の視認性を最大化しつつ、ゲーム画面の機能性を維持

### Improved
- 🎨 **クロスプラットフォーム表示の最適化**
  - 動的ズーム計算を初期化時に実行し、`window.gameZoomFactor`にキャッシュ
  - タイトル画面、ストーリー画面が画面サイズに合わせて最大化
  - タスクバー・タイトルバーの有無に関わらず、全てのPCで適切に表示
  - ゲーム画面のボタン（アルバム、設定）が切れることなく表示

### Technical Details
- `src/js/main.js`:
  - `setupDynamicZoom()` → `calculateDynamicZoom()`にリファクタリング
  - ズーム値の計算のみを行い、適用はシーンマネージャーに委譲
  - `window.gameZoomFactor`にグローバルズーム値を保存
- `src/js/sceneManager.js`:
  - `applySceneZoom(sceneName)`メソッドを新規追加
  - `showScene()`内でシーン切り替え時に自動的にズームを適用
  - `fullSizeScenes`配列で100%表示シーンを管理
- `src/preload.js`:
  - `setZoomFactor()`APIをrendererプロセスに公開
- `src/main.js` (main process):
  - `set-zoom-factor`IPCハンドラーを実装
  - Electronの`webContents.setZoomFactor()`を使用してズーム制御

### User Impact
- 別PCでの表示問題が完全に解決
- タイトル画面とストーリー画面が大きく見やすく表示
- ゲーム画面のUIが全て表示されてプレイに支障なし
- スクロールバーなしで全コンテンツが表示可能

---


## 2025-10-27

### Fixed
- 🐛 **シーン遷移の競合状態バグ修正**
  - データ削除後、タイトル→シナリオ→スキップ→説明画面の遷移で説明画面からタイトルに自動的に戻ってしまう致命的なバグを修正
  - 5回の修正試行を経て、最終的に`startGame()`からシーン遷移ロジックを完全に削除
  - `handleGameStart()`で`startGameCompleted`フラグを即座に設定し、遅延実行を防止
  - `startGame()`はデータ読み込みのみを担当し、シーン遷移は行わない設計に変更

- 🐛 **オーディオオーバーレイのブロッキング問題修正**
  - タイトル画面から他画面に遷移する際、オーディオオーバーレイ(z-index: 1000)が残ってボタンクリックをブロックする問題を修正
  - `onSceneEnter()`でタイトル画面を離れる際に`hideAudioOverlay()`を自動呼び出し

- 🐛 **ITM_CLICK_1の購入コスト計算修正**
  - デフォルト所持数1(基本クリック力)のITM_CLICK_1の購入コストが60ptから始まる問題を修正
  - `calculateItemCost()`に`itemId`パラメータを追加し、ITM_CLICK_1の特別処理を実装
  - 所持数1を所持数0として扱うことで、購入コストが50pt(基本コスト)から始まるように修正
  - `shopSystem.js`内の全9箇所の`calculateItemCost()`呼び出しを更新

### Improved
- ⚡ **起動時のローディング時間最適化**
  - ポーリング間隔を100msから25msに短縮(4倍高速化)
  - 初期化完了後の1秒遅延を削除
  - 合計3～4秒のローディング時間短縮を実現

### Technical Details
- `sceneManager.js`:
  - `startGame()`: シーン遷移ロジックを削除、データ読み込みのみに専念
  - `handleGameStart()`: `startGameCompleted = true`を即座に設定
  - `onSceneEnter()`: タイトル画面離脱時のオーディオオーバーレイ非表示処理を追加
- `main.js`:
  - ポーリング間隔を100ms→25msに変更(line 84)
  - ショップ更新の1秒遅延を削除(lines 53-57)
- `gameState.js`:
  - `calculateItemCost()`: `itemId`パラメータ追加、ITM_CLICK_1特別処理実装(lines 141-153)
  - `getItemCost()`: `itemId`パラメータを`calculateItemCost()`に渡すように更新(lines 156-159)
- `shopSystem.js`:
  - 全9箇所の`calculateItemCost()`呼び出しに`itemId`パラメータを追加

### Bug Fix History
**シーン遷移バグ - 5回の修正試行:**
1. 試行1: `showScene('title')`に`await`追加 → 失敗
2. 試行2: `wasOnLoadingScreen`変数でダブルチェック → ポータブル版で失敗
3. 試行3: 遅延前にチェックを移動、早期return追加 → 1秒遅延問題残存
4. 試行4: `isTransitioning`チェック追加 → タイミング問題解決せず
5. 試行5 (成功): `startGame()`から全シーン遷移削除、`handleGameStart()`で即座にフラグ設定

**根本原因:**
- `startGame()`の非同期データ読み込みとユーザーナビゲーション(タイトル→シナリオ→説明画面)の競合
- `startGame()`完了後の`showScene('title')`呼び出しがユーザーの画面遷移を上書き
- `currentScene`が`onSceneEnter()`完了後に更新されるため、タイミング依存の問題が発生

**最終解決策:**
- アーキテクチャの根本的変更
- `startGame()`: データ読み込みのみ
- シーン遷移: `main.js:572`で1回のみ実行
- フラグ設定: ユーザーが「ゲーム開始」クリック時に即座に設定

---


## 2025-10-18

### Fixed
- 🐛 **ガチャボタンのグレーアウト機能実装**
  - ポイント不足時にガチャボタンが視覚的に無効化されるように修正
  - 無効時: グレー背景 (#b2bec3)、透明度60%、カーソル変更
  - 有効時: ピンクグラデーション背景、通常カーソル
  - インラインスタイルで強制的に背景色を設定し、CSS優先度問題を解決
  - ユーザビリティ向上: ガチャが引けない状態が一目で分かるように

### Technical Details
- `gachaSystem.js`:
  - `initializeElements()`: 要素ID修正（`-modal` サフィックス対応）
  - `setGachaButtonState()`: インライン背景スタイル設定を追加
  - `set10xGachaButtonState()`: インライン背景スタイル設定を追加
  - 無効時スタイル: `background: #b2bec3`, `opacity: 0.6`, `cursor: not-allowed`
  - 有効時スタイル: グラデーション背景、`opacity: 1`, `cursor: pointer`

---


## 2025-10-17
### Added
- ✨ **累進価格システム実装**
  - 同じアイテムを購入するたびに価格が上昇する仕組みを実装
  - クリック系アイテム: 1.15倍の累進倍率
  - CPS系アイテム: 1.22倍の累進倍率
  - 価格計算式: `基本価格 × (倍率)^購入回数`
  - 低コストアイテム連打戦略を防ぎ、上位アイテムの価値を向上

- ✨ **ショップUI改善**
  - 全数値表示に3桁区切りカンマを追加
    - 所持数: `1234個所持` → `1,234個所持`
    - 購入個数: `10個購入` → `10個購入`
    - コスト: `5000pt` → `5,000pt`
    - 効果値: `+1234pt` → `+1,234pt`
  - MAX購入で買えない時に最低必要ポイントを表示
    - グレーアウト状態で「5,678pt～」と表示
    - 次のアイテム購入に必要なポイントが一目で分かる

### Changed
- 🎮 **ゲームバランス大幅調整**
  - **アイテム効果値の大幅強化** (レベル2以降)
    - クリック系: 1/5/20/75/300 → 1/30/400/5000/50000
    - CPS系: 1/5/20/75/300 → 1/30/400/5000/50000
  - **アイテム基本コスト調整**
    - クリック系: 100/2000/25000/300000/3000000 → 50/1000/20000/300000/3000000
    - CPS系は変更なし (1000/5000/50000/500000/5000000)
  - **ガチャコスト大幅引き上げ**
    - Stage 1: 1,000pt (変更なし)
    - Stage 2: 2,000pt → 5,000pt (2.5倍)
    - Stage 3: 3,000pt → 15,000pt (5倍)
    - Stage 4: 5,000pt → 50,000pt (10倍)
  - **ステージ解放コスト引き上げ**
    - Stage 2: 10,000pt → 50,000pt (5倍)
    - Stage 3: 100,000pt → 500,000pt (5倍)
    - Stage 4: 1,000,000pt → 5,000,000pt (5倍)

### Fixed
- 🐛 **PPS表示の非表示化**
  - 描画不具合があった「1秒当たりの獲得ポイント」表示を非表示に設定

### Technical Details
- `gameState.js`:
  - `calculateItemCost()`: 購入回数に応じた累進価格計算
  - `getItemCost()`: アイテムの現在コスト取得
- `shopSystem.js`:
  - `calculateMaxAffordableForItemProgressive()`: 累進価格対応のMAX購入計算
  - `buildItemElement()`: 累進価格を考慮した表示生成
  - `updateItemDisplay()`: 累進価格を考慮した表示更新
  - 3桁区切りカンマ表示の実装
  - MAX購入0個時の最低価格表示
- `items.csv`: 効果値・基本コスト・累進倍率を追加
- `stages.csv`: ガチャコスト・ステージ解放コストを更新

### Balance Analysis
**第1回テストプレイ結果:**
- プレイ時間: 約15分でエンディング到達
- 問題点: 低コストアイテム連打で簡単にクリア可能
- 原因: 固定価格制により上位アイテムの価値が低い

**調整後の想定プレイ時間:** 10～30時間
- 累進価格により長期的なプレイを促進
- 上位アイテムが後半で魅力的になる設計
- ガチャ・ステージ解放コストの引き上げで収集要素の重みを増加

---

## 2025-10-15

### Testing
- 🧪 **ゲームバランステスト実施**
  - テストプレイ時間: 23:33～23:48 (約15分)
  - 結果: 想定プレイ時間より大幅に短くクリア
  - 課題: バランス調整が必要と判断

### Added
- ✨ **アルバム再生機能実装**
  - アルバム画面からシナリオとエンディングを再生可能に
  - アルバムから遷移した場合は「アルバムに戻る」ボタンのみ表示
  - 通常のゲームフローでは従来のボタンレイアウトを維持
  - `sceneManager.js` に `fromAlbum` パラメータと条件分岐を実装
  - シナリオ・エンディング再生中のクリックポイント加算を無効化
  - アルバムタブ状態の保持機能（シナリオ/エンディングタブから戻った際に同じタブを表示）

### Fixed
- 🐛 **アルバム再生ボタンの即時表示**
  - CSS アニメーション遅延を無効化（`!important` フラグ使用）
  - ボタンの即時クリック可能化（`pointer-events: auto`）
  - 11秒のテキストアニメーション待ち時間を解消

### Changed
- 🎨 **シナリオボタン名称変更**
  - 「ゲーム説明」→「シナリオ」に変更
  - アルバム画面でより直感的な表記に

### Technical Details
- `albumManager.js`:
  - `currentTab` プロパティでタブ状態を追跡
  - `restoreScenarioTab()`, `restoreEndingTab()` メソッド実装
  - `playScenario()`, `playEnding()` に `fromAlbum` フラグ付与
- `sceneManager.js`:
  - `showScene()` メソッドに `fromAlbum` パラメータ追加
  - `initializeScenarioScene()`, `initializeEnding2Scene()` で条件分岐実装
  - クリックシステム無効化リストに `'scenario'` 追加
- `main.css`:
  - `#scenario-back-to-album-btn`, `#ending2-back-to-album-btn` の即時表示スタイル追加

### Current Balance Analysis
**ステージ解放コスト:**
- ステージ1: 0（初期解放）
- ステージ2: 2,000
- ステージ3: 15,000
- ステージ4: 100,000

**アイテムコスト（実装値）:**
- クリック強化: 50 / 2,000 / 25,000 / 300,000 / 3,000,000
- PPS強化: 500 / 5,000 / 50,000 / 500,000 / 5,000,000

**ガチャ総コスト見積もり:**
- 全160枚収集: 約57,000ポイント
- ステージ解放込み: 約174,000ポイント

---

## 2025-10-12

### Added
- ✨ **ラッキーエフェクトシステム実装**
  - クールタイム（5分 + 500クリック）後に虹色ハートが出現
  - 高速移動する虹色ハートをクリックすると大量ポイント獲得
  - 報酬計算式: `(クリック力 + CPS × 1.0) × 最大ステージ + 総ポイント × 0.05`
  - デバッグモード時はクールタイム無効化（即座にスポーン）
  - `luckyEffectManager.js` を新規実装

- ✨ **10連ガチャシステム実装**
  - 単発ガチャに加えて10連ガチャボタンを追加
  - 10連ガチャは5x2のグリッド表示で結果を表示
  - 単発・10連ともに統一されたUIデザイン（黒背景、ゴールド装飾）
  - 10連ガチャの結果表示は順次アニメーション

### Fixed
- 🐛 **ガチャ後の画像表示バグ修正**
  - 単発・10連ガチャ実行後、引いた画像がクリックエリアに表示されない問題を修正
  - `isGachaAnimating` フラグのタイミング問題を解決
  - ガチャオーバーレイ終了後、明示的に `updateHeroineDisplay()` を呼び出すように修正

- 🐛 **アルバム画面のUI改善**
  - 「拡大表示」ボタンを削除し、「画像をクリックすると拡大表示」ヒントテキストに変更
  - 拡大表示モーダルの画像と背景のズレを修正
  - 閉じるボタン（×）の縦方向中央揃え修正
  - 閉じるボタンを画像外側に配置（画像に重ならないように）
  - 黒背景クリックでモーダルを閉じる機能を追加

- 🐛 **BGM音量バランス調整**
  - ステージ2 BGM音量を0.1から0.3に変更（他ステージと統一）

### Changed
- 🎨 **ガチャUIの統一**
  - 単発ガチャの演出を10連ガチャと同じスタイルに統一
  - ボタン回転アニメーションを削除し、オーバーレイ表示方式に変更
  - 獲得テキストを「新しいキャラクターを獲得！」から「新しい画像を獲得！」に変更

- 🎨 **アルバムヒントテキストのスタイル改善**
  - 青グラデーション背景で「戻る」ボタンと統一
  - 大きく太字で目立つデザインに変更

### Technical Details
- `luckyEffectManager.js`: ラッキーエフェクトの完全実装
  - ランダム高速移動アルゴリズム (8px/frame)
  - 虹色グローアニメーション (0.8s)
  - クリック報酬計算とポップアップ表示
- `gachaSystem.js`: 10連ガチャメソッド追加 + UI統一
- `albumManager.js`: モーダル表示ロジック改善
- `game.css`: ラッキーエフェクト、ガチャ、アルバムのスタイル追加/修正
- `audio.csv`: ステージ2 BGM音量調整

---

## 2025-10-11

### Added
- ✨ **ステージ3のヒロイン画像実装**
  - 50枚の画像を追加 (`heroine_3_01.png` ~ `heroine_3_50.png`)
  - `assets/images/heroines/stage3/` ディレクトリに配置
  - `images.csv` に全50件のエントリを追加

- ✨ **ステージ4のヒロイン画像実装**
  - 70枚の画像を追加 (`heroine_4_01.png` ~ `heroine_4_70.png`)
  - `assets/images/heroines/stage4/` ディレクトリに配置
  - `images.csv` に全70件のエントリを追加
  - 全160枚のヒロイン画像実装完了 (10+30+50+70)

### Fixed
- 🐛 **クリック判定エリアの最適化**
  - クリック可能エリアを画像の中央50%に制限
  - 左右25%のマージンを設定し、キャラクター部分のみクリック可能に
  - `clickSystem.js` の `isWithinClickableArea()` メソッドを改善

- 🐛 **クリックエフェクト位置の修正**
  - `#click-effects` コンテナを `body` レベルに移動
  - CSS を `position: absolute` から `position: fixed` に変更
  - ビューポート座標系を使用してエフェクト位置を正確に表示

### Changed
- 🎨 **チュートリアル画面の色調整**
  - 背景を緑系グラデーションからピンク系グラデーション (`#ff9a9e` → `#fecfef`) に変更
  - ステップ背景を緑系からピンク系 (`rgba(253, 121, 168, 0.1)`) に変更
  - ステップ番号バッジを緑 (`#00b894`) からピンク (`#e84393`) に変更
  - ゲーム全体のピンク系配色に統一

- 📝 **データ修正**
  - `stages.csv` のステージ1ヒロイン数を9から10に修正

### Technical Details
- Python スクリプトを使用して画像ファイルを一括コピー・リネーム
- 画像ファイル名は2桁ゼロパディング形式 (01, 02, ..., 70)
- すべての変更をGitHubリポジトリにコミット・プッシュ済み

---

## 2025-10-08

### Added
- ✨ **タイトル画面背景画像の実装**
  - 夕焼けの校舎を背景にした高品質な背景画像を追加
  - `title_background_sunset.png` (1920x1080, 2.6MB)
  - 放課後の雰囲気を完璧に表現

### Changed
- 🎨 **タイトル画面のUI改善**
  - 背景を単色グラデーションから夕焼け校舎の画像に変更
  - コンテンツエリアに半透明の白い背景を追加 (`rgba(255, 255, 255, 0.15)`)
  - ぼかし効果 (`backdrop-filter: blur(10px)`) で視認性を向上
  - ロゴ、キャラクター、ボタンが背景画像と調和しながらしっかり見える

### Technical Details
- `src/styles/main.css`: タイトル画面のスタイル更新
  - 背景画像のパス設定
  - コンテンツエリアのスタイリング強化
- `assets/images/ui/`: 背景画像ファイル追加
  - `title_background_sunset.png` - メイン背景（夕焼け校舎）
  - `title_background.png` - シンプル版（予備）
  - `title_background_classroom.png` - 教室要素版（予備）

### Notes
- 元のグラデーション背景はCSSコメントで保持（簡単に切り替え可能）
- 複数の背景オプションを用意し、必要に応じて切り替え可能な設計

---

## Previous Updates

### ゲームシステム実装状況
- ✅ 基本ゲームシステム完成（クリック、ショップ、ガチャ、セーブ/ロード）
- ✅ 全ステージのヒロイン画像実装完了 (160枚)
  - ステージ1: 10枚
  - ステージ2: 30枚
  - ステージ3: 50枚
  - ステージ4: 70枚
- ✅ 音響システム完成（BGM、SE、フェード機能）
- ✅ アルバム機能実装
- ✅ UI/UX完成（全画面の色調統一、クリック判定最適化）
- ❌ 報酬動画未実装 (4本) - オプション
- ⏳ 最終テスト・バランス調整 - 残作業
- ⏳ 配布用ビルド作成 - 残作業

### 進捗率
- **プログラム**: 100% (完成)
- **コンテンツ**: 100% (全ヒロイン画像実装完了)
- **UI/UX**: 100% (完成)
- **ゲームバランス**: 80% (累進価格システム実装完了、再テスト待ち)
- **全体進捗**: 95% (バランステスト・ビルドのみ残)
